#!bash
#
# Usage: clicraft backup
#
#    Backs up world data.
#

# Usage: clicraft restore [file.zip] [files]
#
#    Restores world data.
#

WORLD=$(serverprop 'level-name')
BACKUP_DIR="${BACKUP_DIR-$SERVER_DIR/backups}"
BACKUP_TARGETS="${BACKUP_TARGETS-"$WORLD ${WORLD}_*"}"
BACKUP_FORMAT="${BACKUP_FORMAT-$WORLD-%Y%m%d-%H%M%S.zip}"

# expand globs
TARGETS=()
for TARGET in "${BACKUP_TARGETS[@]}"; do
	if [[ "${TARGET:0:1}" = '/' ]]; then
		warn "Absolute path in BACKUP_TARGETS detected: $TARGET"
		warn "Restoring this backup may fail"
	fi
	TARGETS=( "${TARGETS[@]}" $TARGET )
done

mkdir -p "$BACKUP_DIR"

backup() {
	if ! mklock save; then
		err "Could not lock the save state, is another clicraft process running?"
		exit 1
	fi

	if status; then
		pushtrap "cmd save-on"
		cmd save-off
		cmd save-all
	fi

	zip -r "$BACKUP_DIR/$(date "+$BACKUP_FORMAT")" "${TARGETS[@]}"

	if status; then
		cmd save-on
		poptrap "cmd save-on"
	fi

	rmlock save
}

restore() {
	local dir FILE

	if [[ "$1" = "" ]]; then
		pushd "$BACKUP_DIR" >/dev/null
		ls
		popd "$BACKUP_DIR" >/dev/null
	else
		FILE="$1"
		shift

		if action status >&2 2>/dev/null; then
			return 1
		fi

		# prompts for file collisions
		unzip "$BACKUP_DIR/$FILE" "$@"
	fi
}

case "$ACTION" in
  backup) backup ;;
  restore) restore "$@" ;;
esac

